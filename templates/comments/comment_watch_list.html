{% extends base_template %}
{% load i18n %}
{% block content %}
  <ul class="breadcrumb">
    <li><a href="{% url "pybb:index" %}">{% trans "forum" %}</a></li>
    <li class="active">{% trans "subscription list" %}</li>
  </ul>
  <h3>{% trans "Subscription list" %}</h3>
  {% if object_list %}
    <table class="table">
      <tr>
        <th>{% trans "Title" %}</th>
        <th>{% trans "New comments" %}</th>
        <th></th>
      </tr>
      {% for object in object_list %}
        <tr>
          <td>
            <a href='{{ object.object.get_absolute_url }}?page=last'>
              {{ object.object.title }}</a>
          </td>
          <td>
            <a href="#" rel="tooltip"
               data-toggle="subscription-read"
               data-url="{{ object.get_api_subscription_read }}"
               data-title="{% trans "Mark as read" %}">
            <i class='glyphicon glyphicon-asterisk'></i>
              {{ object.get_new_comments.count }}</a>
          </td>
          <td>
            <a href="{{ object.get_subscription_remove_url }}" rel="tooltip"
               data-title="{% trans "Remove subscription" %}">
              <i class="icon-remove icon-delete"></i></a>
          </td>
        </tr>
      {% endfor %}
    </table>
    {% include "generic/paginator.html" %}
  {% else %}
    <h3>{% trans "No subscriptions found/no new content" %}</h3>
  {% endif %}

  <script type="text/javascript">
    (function(){
      $('[data-toggle=subscription-read]').click(function(e){
        var self = $(this);
        var data = {
          is_updated: false,
          csrfmiddlewaretoken: getCookie('csrftoken')
        };
        $.ajax({
          headers: {
            'X-HTTP-Method-Override': 'PATCH',
          },
          type: "POST",
          url: self.data('url'),
          data: data,
          //dataType: 'json',
          success: function(data, textStatus, jqXHR){
            if (!data.is_updated){
              noty({
                text: "{% trans "Successfully updated, reload the page" %}",
                type: "success",
                dimissQueue: true,
                timeout: 2000
              })
            } else {
              noty({
                text: "{% trans "Failed :(" %}",
                type: 'warning',
                dismissQueue: true
              });
            }
          }
        });
      });
    })();
  </script>

{% endblock %}